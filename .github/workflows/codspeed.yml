name: codspeed-benchmarks

on:
  # Run on pushes to the main branch
  push:
    branches:
      - "main"
  # Run on pull requests
  pull_request:
  # `workflow_dispatch` allows CodSpeed to trigger backtest
  # performance analysis in order to generate initial data.
  workflow_dispatch:

jobs:
  benchmarks:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -el {0}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - uses: conda-incubator/setup-miniconda@v3
        with:
          environment-file: ci/environment.yml
          activate-environment: ndpyramid
          python-version: "3.10"
          auto-activate-base: false

      - name: Install package
        run: |
          # $CONDA is an environment variable pointing to the root of the miniconda directory
          # Preprend $CONDA/bin to $PATH so that conda's python is used over system python
          echo $CONDA/bin >> $GITHUB_PATH
          conda env list
          conda list
          python -m pip install -e . --no-deps

      - name: Run benchmarks
        uses: CodSpeedHQ/action@v2
        with:
          run: |
            python -c "import ndpyramid; print(ndpyramid.__version__)"
            python -m pytest --codspeed
